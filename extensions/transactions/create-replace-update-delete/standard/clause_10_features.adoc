[[features_clause]]
== Requirements Class "Features"

=== Overview

include::requirements/requirements_class_features.adoc[]

This clause defines requirements for the case when the resource type is a
feature.

[[features-endpoint]]
=== Resources endpoint

include::requirements/features/REQ_resources-endpoint.adoc[]

[[feature-endpoint]]
=== Resource endpoint

include::requirements/features/REQ_resource-endpoint.adoc[]

[[put-create-feature]]
=== Support for creating features using the PUT method

include::requirements/features/REQ_collection-endpoint.adoc[]

[#collection-example,reftext=`Collection with supportsNonAutogeneratedResourceIds Example`]
.A collection with `supportsNonAutogeneratedResourceIds` set to `true`
include::../examples/json/ex07_supportsNonAutogeneratedResourceIds.adoc[]

[[return-created-feature]]
=== Support for returning a created feature

T.B.D.

[[feature-crs]]
=== Coordinate reference systems (CRS)

Unless the server supports <<OAFeat-2,OGC API - Features - Part 2: Coordinate Reference Systems by Reference>>, all geometries have to be submitted in the default CRS.

include::requirements/features/crs/REQ_crs84.adoc[]

If the server supports <<OAFeat-2,OGC API - Features - Part 2: Coordinate Reference Systems by Reference>>, the default CRS can be overridden by declaring the `Content-Crs` header in the request. Alternatively, if the feature representation supports expressing CRS information for each feature / geometry, the information can also be included in the feature representation.

include::requirements/features/crs/REQ_content-crs-header.adoc[]

include::requirements/features/crs/REQ_default-crs.adoc[]

include::requirements/features/crs/REQ_other-crs.adoc[]

This approach is consistent with the use of WGS84 longitude/latitude as the default CRS for all feature-related requests in API implementation instances. If both the server and the client are CRS-aware and have the capability to handle geometries in other CRSs, this requirement enables the client to negotiate to some other mutually agreeable CRS.

*Example*

The following example adds a new feature to the `dc_buildings` collection.  The feature is represented as GeoJSON and the `Content-Crs` HTTP header is used to assert that the geometry coordinates are expressing using CRS http://www.opengis.net/def/crs/EPSG/0/32607 (WGS 84 / UTM zone 7N).  A pseudo-sequence diagram notation is used to illustrate the details of the HTTP communication between the client and the server.

[#create-crs-example,reftext=`Create Example with non-default CRS`]
.Create a new feature expressed using a non-default CRS.
include::../examples/json/ex05_create-crs.adoc[]

If the server includes the `storageCrs` property in the Collection resource, as specified in <<OAFeat-2,OGC API - Features - Part 2: Coordinate Reference Systems by Reference>>, then it is recommended that client express all geometry-valued feature properties presented to the server in a request body using the storage CRS. This avoids geometric errors from the conversion of coordinates on the server when storing the geometry.

include::recommendations/features/REC_storage-crs.adoc[]

[[schemas]]
=== Feature schemas

Adding, replacing, or updating a feature requires that a representation of that feature or the updated properties be provided by the client. As is the case in Part 1 (Core), this Standard does not mandate that a specific feature encoding be supported by a server.

If features in a collection are constrained to a specific schema and schema information is provided by a server, the Schema resource of a collection is available at `{landingPageUri}/collections/{collectionId}/schema` as specified by Part 5 (Schemas). This information enables clients to generate feature representations that are acceptable to the server. 

include::requirements/features/REQ_schema.adoc[]

The schema identifies the feature properties that can be used in a mutation request (Receivables), that is, all properties that are not tagged as `readOnly`.

The mapping between the properties in the encoded feature and the properties in the JSON Schema depends on the feature encoding. This Standard provides guidance for API implementation instances that support GeoJSON.

*Example*

The following example fetches the schema for the `oakland_buildings` collection. Pseudo-sequence diagram notation is used to illustrate the details of the HTTP communication between the client and the server. Remarks:

- Since the schema includes a statement `"additionalProperties": false`, the server will reject any feature that has additional properties that are not specified in the schema.
- The `id` member is read-only as the feature identifier is assigned by the server on a POST request. In a PUT or PATCH request, the feature identifier is part of the URI.

[#schema,reftext=`Schema Example`]
.Schema Example
include::../examples/json/schema.adoc[]

=== JSON Merge Patch

<<rfc7396,RFC 7396 (JSON Merge Patch)>> can be used to update selected properties of a feature, if the schema of the feature as described in the previous sub-clause is available. This is independent of the feature encodings supported by the API.

include::requirements/features/REQ_update-json-merge-patch.adoc[]

[NOTE]
====
Requirement <<req_features_update-json-merge-patch,/req/features/update-json-merge-patch>> is only in effect if the server supports <<rfc7396,RFC 7396 (JSON Merge Patch)>> as the vocabulary used to describe changes to feature components.
====

include::recommendations/features/PER_other_update_vocabs.adoc[]

[[feature-geojson]]
=== GeoJSON

include::requirements/features/REQ_geojson-create-replace.adoc[]

GeoJSON normatively supports WGS84 longitude/latitude, but the https://www.rfc-editor.org/rfc/rfc7946.html#section-4["prior arrangement" provision] allows that other CRSs can be used if both client and server agree on the CRS. Clients that want to use a CRS that is not the default CRS have to state the CRS in the POST, PUT or PATCH request using the `Content-Crs` HTTP header to invoke the "prior arrangement" provision. 

[[feature-gml]]
=== Geography Markup Language (GML)

include::requirements/features/REQ_gml-create-replace.adoc[]

include::requirements/features/crs/REQ_gml-srsname.adoc[]

This Standard does not specify an XML PATCH syntax / semantics that could be applied for GML feature updates. Two options are:

- use of the http://docs.opengeospatial.org/is/09-025r2/09-025r2.html#283[Update action from OGC Web Feature Service 2.0]; 
- use of <<rfc5261,RFC 5261 (An Extensible Markup Language (XML) Patch Operations Framework Utilizing XML Path Language (XPath) Selectors)>>.
